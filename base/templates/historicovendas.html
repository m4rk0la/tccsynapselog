{% extends "layout_base.html" %}

{% block title %}Hist√≥rico de Vendas - SynapseLog{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css">
<style>
    .page-header {
        margin-bottom: 30px;
    }
    
    .page-header h1 {
        font-size: 28px;
        color: var(--text);
        margin-bottom: 8px;
    }
    
    .page-header p {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--accent);
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .table-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .search-box {
        flex: 1;
        min-width: 300px;
    }
    
    .search-box input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text);
        font-size: 14px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: var(--accent);
        color: white;
    }
    
    .btn-primary:hover {
        background: #4f46e5;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    #sales-table {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
    }
    
    .tabulator {
        background: transparent;
        border: none;
    }
    
    .tabulator-header {
        background: #ffffff !important;
        border-bottom: 2px solid var(--border);
    }
    
    .tabulator-col {
        background: #ffffff !important;
        border-right: 1px solid var(--border);
    }
    
    .tabulator-col-title {
        color: #000000;
        font-weight: 600;
        text-align: center;
    }
    
    .tabulator-row {
        background: #374151 !important;
        border-bottom: 1px solid var(--border);
    }
    
    .tabulator-row.tabulator-row-even,
    .tabulator-row.tabulator-row-odd {
        background: #374151 !important;
    }
    
    .tabulator-row:hover {
        background: var(--border) !important;
    }
    
    .tabulator-cell {
        color: var(--text);
    }
    
    /* Bot√µes de A√ß√£o */
    .action-btn {
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.2s;
        color: white;
        white-space: nowrap;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .btn-details {
        background: #3b82f6; /* Azul */
    }
    
    .btn-details:hover {
        background: #2563eb;
    }
    
    .btn-edit {
        background: #10b981; /* Verde */
    }
    
    .btn-edit:hover {
        background: #059669;
    }
    
    .btn-history {
        background: #8b5cf6; /* Roxo */
    }
    
    .btn-history:hover {
        background: #7c3aed;
    }
    
    .btn-delete {
        background: #ef4444; /* Vermelho */
    }
    
    .btn-delete:hover {
        background: #dc2626;
    }
    
    /* Modal de Preview */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 30px;
        max-width: 95vw;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-header h2 {
        color: var(--text);
        font-size: 24px;
        margin: 0;
    }
    
    .close-modal {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .close-modal:hover {
        background: var(--border);
        color: var(--text);
    }
    
    #preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    #preview-table th {
        background: #ffffff;
        color: #000000;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid var(--border);
        position: sticky;
        top: 0;
        font-weight: 600;
    }
    
    #preview-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        color: var(--text);
    }
    
    #preview-table tr:hover {
        background: var(--border);
    }
    
    .preview-info {
        background: #3b82f6;
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìà Hist√≥rico de Vendas</h1>
    <p>Importe e gerencie seus dados de vendas</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="total-vendas">0</div>
        <div class="stat-label">Total de Vendas</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="total-valor">R$ 0</div>
        <div class="stat-label">Valor Total</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="clientes-unicos">0</div>
        <div class="stat-label">Clientes √önicos</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="ticket-medio">R$ 0</div>
        <div class="stat-label">Ticket M√©dio</div>
    </div>
</div>

<div class="table-toolbar">
    <div class="search-box">
        <input type="text" id="table-search" placeholder="üîç Buscar por ID, cliente, produto...">
    </div>
    <button id="refreshBtn" class="btn btn-primary">
        üîÑ Atualizar
    </button>
    <button id="importBtn" class="btn btn-success">
        üì§ Importar Dados
    </button>
    <button id="exportCsv" class="btn btn-secondary">
        üì• Exportar CSV
    </button>
</div>

<div id="sales-table"></div>

<!-- Modal de Importa√ß√£o -->
<div id="importModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>üì§ Importar Hist√≥rico de Vendas</h2>
            <button class="close-modal" id="closeImportModal">&times;</button>
        </div>
        
        <form method="post" action="{{ url_for('main.historicovendas') }}" enctype="multipart/form-data" id="import-form">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">
                    Arquivo Excel (.xlsx ou .xls)
                </label>
                <input type="file" name="file" id="file-input" accept=".xlsx, .xls" required
                       style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text);">
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                    Tamanho m√°ximo: 50MB
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="button" id="preview-btn" class="btn btn-secondary" style="flex: 1;">
                    üëÅÔ∏è Visualizar
                </button>
                <button type="submit" class="btn btn-success" style="flex: 1;">
                    ‚úÖ Importar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Preview -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üëÅÔ∏è Preview dos Dados</h2>
            <button class="close-modal" id="closePreviewModal">&times;</button>
        </div>
        
        <div class="preview-info" id="preview-info"></div>
        
        <div style="overflow: auto; max-height: 60vh;">
            <table id="preview-table"></table>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Venda -->
<div id="detalhesModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>üìã Detalhes da Venda</h2>
            <button class="close-modal" onclick="fecharModal('detalhesModal')">&times;</button>
        </div>
        <div id="detalhes-content"></div>
    </div>
</div>

<!-- Modal de Editar Venda -->
<div id="editarModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>‚úèÔ∏è Editar Venda</h2>
            <button class="close-modal" onclick="fecharModal('editarModal')">&times;</button>
        </div>
        <div id="editar-content"></div>
    </div>
</div>

<!-- Modal de Hist√≥rico do Cliente -->
<div id="historicoClienteModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>üìä Hist√≥rico do Cliente</h2>
            <button class="close-modal" onclick="fecharModal('historicoClienteModal')">&times;</button>
        </div>
        <div id="historico-content"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
(function(){
    const userId = "{{ session.get('user_id', 'anon') }}";
    let table;

    async function initTable(){
        table = new Tabulator('#sales-table', {
            layout:'fitDataStretch',
            movableColumns:true,
            height:'520px',
            pagination:'local',
            paginationSize:50,
            placeholder:'Nenhuma venda encontrada. Importe um arquivo Excel.',
            tooltips:true,
            reactiveData:true,
            columns:[
                {title:'ID Pedido', field:'id_pedido', headerFilter:'input', width:140},
                {title:'Cliente', field:'hash_cliente', headerFilter:'input', width:180},
                {title:'Produto', field:'id_produto', headerFilter:'input', width:150},
                {title:'Data Compra', field:'data_compra', headerFilter:'input', width:160, sorter:'date', formatter:function(cell){
                    const v = cell.getValue();
                    return v ? new Date(v).toLocaleString('pt-BR') : '';
                }},
                {title:'Valor', field:'valor_total_pagamento', width:120, hozAlign:'right', formatter:function(cell){
                    const v = cell.getValue();
                    return v ? 'R$ ' + parseFloat(v).toFixed(2) : 'R$ 0,00';
                }},
                {title:'Status', field:'status_pedido', headerFilter:'input', width:120},
                {title:'Estado', field:'estado_cliente', width:80, hozAlign:'center'},
                {title:'Nota', field:'nota_avaliacao', width:80, hozAlign:'center'},
                {title:'A√ß√µes', field:'actions', width:280, hozAlign:'center', headerSort:false, formatter:function(cell){
                    const row = cell.getRow().getData();
                    return `
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="action-btn btn-details" onclick='verDetalhesVenda(${JSON.stringify(row).replace(/'/g, "\\'")})' title="Detalhes da Venda">Detalhes</button>
                            <button class="action-btn btn-edit" onclick="editarVenda(${row.id})" title="Editar Venda">Editar</button>
                            <button class="action-btn btn-history" onclick="verHistoricoCliente('${row.hash_cliente}', '${row.data_compra}')" title="Hist√≥rico do Cliente">Hist√≥rico</button>
                            <button class="action-btn btn-delete" onclick="excluirVenda(${row.id}, '${row.id_pedido}')" title="Excluir Venda">Excluir</button>
                        </div>
                    `;
                }}
            ]
        });

        await loadData();
    }

    async function loadData(){
        try {
            const resp = await fetch(`{{ url_for('main.historicovendas') }}?action=get&user_id=${encodeURIComponent(userId)}`);
            if (!resp.ok) throw new Error('Erro ao carregar dados');
            
            const json = await resp.json();
            if (!json.success) throw new Error(json.error || 'Erro desconhecido');
            
            const vendas = json.vendas || [];
            table.setData(vendas);
            
            // Atualizar estat√≠sticas
            updateStats(vendas);
            
        } catch(e) {
            console.error('Erro ao carregar vendas:', e);
        }
    }

    function updateStats(vendas) {
        const totalVendas = vendas.length;
        const totalValor = vendas.reduce((sum, v) => sum + (parseFloat(v.valor_total_pagamento) || 0), 0);
        const clientesUnicos = new Set(
        vendas
            .map(v => (v.hash_cliente ?? v.cliente_id ?? v.cliente_nome ?? ''))
            .map(s => String(s).trim().toLowerCase())
            .filter(s => s.length > 0)
        ).size;
        const ticketMedio = totalVendas > 0 ? totalValor / totalVendas : 0;
        
        document.getElementById('total-vendas').textContent = totalVendas.toLocaleString('pt-BR');
        document.getElementById('total-valor').textContent = 'R$ ' + totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('clientes-unicos').textContent = clientesUnicos.toLocaleString('pt-BR');
        document.getElementById('ticket-medio').textContent = 'R$ ' + ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    
    document.getElementById('table-search').addEventListener('input', function(e){
        const v = e.target.value;
        table.setFilter([
            [
                {field:'id_pedido', type:'like', value:v},
                {field:'hash_cliente', type:'like', value:v},
                {field:'id_produto', type:'like', value:v}
            ]
        ]);
    });

    document.getElementById('exportCsv').addEventListener('click', function(){
        table.download('csv', 'historico_vendas_export.csv');
    });

    // Modal de importa√ß√£o
    const importModal = document.getElementById('importModal');
    document.getElementById('importBtn').addEventListener('click', function(){
        importModal.style.display = 'flex';
    });
    document.getElementById('closeImportModal').addEventListener('click', function(){
        importModal.style.display = 'none';
    });

    // Modal de preview
    const previewModal = document.getElementById('previewModal');
    document.getElementById('closePreviewModal').addEventListener('click', function(){
        previewModal.style.display = 'none';
    });

    // Preview do arquivo
    document.getElementById('preview-btn').addEventListener('click', async function(){
        const fileInput = document.getElementById('file-input');
        if (!fileInput.files || !fileInput.files[0]) {
            alert('‚ö†Ô∏è Selecione um arquivo primeiro.');
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                if (jsonData.length === 0) {
                    alert('‚ùå Arquivo vazio');
                    return;
                }

                // Criar tabela de preview
                const headers = jsonData[0];
                const rows = jsonData.slice(1, 101); // Limita a 100 linhas

                let html = '<thead><tr>';
                headers.forEach(h => html += `<th>${h || ''}</th>`);
                html += '</tr></thead><tbody>';

                rows.forEach(row => {
                    html += '<tr>';
                    headers.forEach((_, i) => {
                        html += `<td>${row[i] !== undefined ? row[i] : ''}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';

                document.getElementById('preview-table').innerHTML = html;
                document.getElementById('preview-info').textContent = 
                    `üìä ${jsonData.length - 1} linhas encontradas (mostrando primeiras 100) | ${headers.length} colunas`;
                
                previewModal.style.display = 'flex';
                importModal.style.display = 'none';

            } catch(err) {
                console.error(err);
                alert('‚ùå Erro ao processar arquivo: ' + err.message);
            }
        };

        reader.readAsArrayBuffer(file);
    });

    // Event delegation for delete buttons
    document.getElementById('sales-table').addEventListener('click', async function(e){
        if(e.target.classList.contains('delete-btn')){
            const id = e.target.getAttribute('data-id');
            if(!confirm('Deseja realmente excluir esta venda?')) return;
            
            try{
                const resp = await fetch(`{{ url_for('main.historicovendas') }}?action=delete`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id, user_id: userId})
                });
                const result = await resp.json();
                if(result.success){
                    await loadData();
                    alert('‚úÖ Venda exclu√≠da com sucesso!');
                } else {
                    alert('‚ùå Erro ao excluir: ' + (result.error || 'desconhecido'));
                }
            }catch(err){
                console.error(err);
                alert('‚ùå Erro ao excluir venda');
            }
        }
    });

    // Inicializar tabela
    initTable();
    
    // ==================== FUN√á√ïES DOS BOT√ïES DE A√á√ÉO ====================
    
    // Fun√ß√£o para fechar modais
    window.fecharModal = function(modalId) {
        document.getElementById(modalId).style.display = 'none';
    };
    
    // Fun√ß√£o: Ver Detalhes da Venda
    window.verDetalhesVenda = function(venda) {
        const modal = document.getElementById('detalhesModal');
        const content = document.getElementById('detalhes-content');
        
        content.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; color: var(--text);">
                <div>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üì¶ Informa√ß√µes do Pedido</h3>
                    <p><strong>ID Pedido:</strong> ${venda.id_pedido || 'N/A'}</p>
                    <p><strong>ID Item:</strong> ${venda.id_item_pedido || 'N/A'}</p>
                    <p><strong>Status:</strong> <span style="color: #10b981;">${venda.status_pedido || 'N/A'}</span></p>
                    <p><strong>Data Compra:</strong> ${venda.data_compra ? new Date(venda.data_compra).toLocaleString('pt-BR') : 'N/A'}</p>
                    <p><strong>Data Entrega:</strong> ${venda.data_entrega_cliente ? new Date(venda.data_entrega_cliente).toLocaleString('pt-BR') : 'N/A'}</p>
                    <p><strong>Tempo Entrega:</strong> ${venda.tempo_entrega_dias || 0} dias</p>
                    <p><strong>Atraso:</strong> ${venda.atraso_entrega_dias || 0} dias</p>
                </div>
                <div>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üë§ Cliente</h3>
                    <p><strong>Nome:</strong> ${venda.hash_cliente || 'N/A'}</p>
                    <p><strong>Cidade:</strong> ${venda.cidade_cliente || 'N/A'}</p>
                    <p><strong>Estado:</strong> ${venda.estado_cliente || 'N/A'}</p>
                    <p><strong>CEP:</strong> ${venda.cep_cliente || 'N/A'}</p>
                    <br>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üõçÔ∏è Produto</h3>
                    <p><strong>ID Produto:</strong> ${venda.id_produto || 'N/A'}</p>
                </div>
                <div>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üí∞ Valores</h3>
                    <p><strong>Pre√ßo:</strong> R$ ${parseFloat(venda.preco || 0).toFixed(2)}</p>
                    <p><strong>Frete:</strong> R$ ${parseFloat(venda.valor_frete || 0).toFixed(2)}</p>
                    <p><strong>Total Item:</strong> R$ ${parseFloat(venda.valor_total_item || 0).toFixed(2)}</p>
                    <p><strong>Total Pagamento:</strong> <span style="color: #10b981; font-size: 18px; font-weight: bold;">R$ ${parseFloat(venda.valor_total_pagamento || 0).toFixed(2)}</span></p>
                    <p><strong>N¬∫ Pagamentos:</strong> ${venda.num_pagamentos || 'N/A'}</p>
                    <p><strong>Tipo Pagamento:</strong> ${venda.tipos_pagamento || 'N/A'}</p>
                    <p><strong>Max Parcelas:</strong> ${venda.max_parcelas || 'N/A'}</p>
                </div>
                <div>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">‚≠ê Avalia√ß√£o</h3>
                    <p><strong>Nota:</strong> ${venda.nota_avaliacao ? '‚≠ê'.repeat(venda.nota_avaliacao) + ` (${venda.nota_avaliacao}/5)` : 'Sem avalia√ß√£o'}</p>
                    <p><strong>T√≠tulo:</strong> ${venda.titulo_comentario || 'N/A'}</p>
                    <p><strong>Coment√°rio:</strong></p>
                    <p style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; font-style: italic;">
                        ${venda.mensagem_comentario || 'Sem coment√°rio'}
                    </p>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="fecharModal('detalhesModal')">Fechar</button>
            </div>
        `;
        
        modal.style.display = 'flex';
    };
    
    // Fun√ß√£o: Editar Venda
    window.editarVenda = async function(id) {
        const modal = document.getElementById('editarModal');
        const content = document.getElementById('editar-content');
        
        // Buscar dados da venda
        try {
            const resp = await fetch(`{{ url_for('main.historicovendas') }}?action=get&user_id=${encodeURIComponent(userId)}`);
            const json = await resp.json();
            const venda = json.vendas.find(v => v.id === id);
            
            if (!venda) {
                alert('‚ùå Venda n√£o encontrada');
                return;
            }
            
            content.innerHTML = `
                <form id="form-editar-venda" style="color: var(--text);">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status do Pedido</label>
                        <select id="edit-status" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text);">
                            <option value="delivered" ${venda.status_pedido === 'delivered' ? 'selected' : ''}>Entregue</option>
                            <option value="shipped" ${venda.status_pedido === 'shipped' ? 'selected' : ''}>Enviado</option>
                            <option value="processing" ${venda.status_pedido === 'processing' ? 'selected' : ''}>Processando</option>
                            <option value="canceled" ${venda.status_pedido === 'canceled' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nota de Avalia√ß√£o (1-5)</label>
                        <input type="number" id="edit-nota" min="1" max="5" value="${venda.nota_avaliacao || ''}" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text);">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">Salvar</button>
                        <button type="button" class="btn btn-secondary" onclick="fecharModal('editarModal')" style="flex: 1;">Cancelar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('form-editar-venda').addEventListener('submit', async function(e) {
                e.preventDefault();
                alert('‚ö†Ô∏è Fun√ß√£o de edi√ß√£o ainda n√£o implementada no backend');
                // TODO: Implementar rota de edi√ß√£o no routes.py
                fecharModal('editarModal');
            });
            
            modal.style.display = 'flex';
        } catch(err) {
            console.error(err);
            alert('‚ùå Erro ao carregar dados da venda');
        }
    };
    
    // Fun√ß√£o: Ver Hist√≥rico do Cliente
    window.verHistoricoCliente = async function(hashCliente, dataCompraAtual) {
        const modal = document.getElementById('historicoClienteModal');
        const content = document.getElementById('historico-content');
        
        try {
            const resp = await fetch(`{{ url_for('main.historicovendas') }}?action=get&user_id=${encodeURIComponent(userId)}`);
            const json = await resp.json();
            const vendasCliente = json.vendas.filter(v => v.hash_cliente === hashCliente);
            
            if (vendasCliente.length <= 1) {
                content.innerHTML = `
                    <p style="text-align: center; color: var(--text-muted); padding: 40px;">
                        Este cliente possui apenas 1 compra registrada.
                    </p>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="fecharModal('historicoClienteModal')">Fechar</button>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            // Calcular estat√≠sticas
            const totalCompras = vendasCliente.length;
            const valorTotal = vendasCliente.reduce((sum, v) => sum + parseFloat(v.valor_total_pagamento || 0), 0);
            const ticketMedio = valorTotal / totalCompras;
            
            // Encontrar a data da √∫ltima compra (mais recente)
            let ultimaCompra = null;
            if (vendasCliente.length > 0) {
                const datasOrdenadas = vendasCliente
                    .map(v => v.data_compra)
                    .filter(d => d) // Remove nulls
                    .sort((a, b) => new Date(b) - new Date(a)); // Ordena decrescente
                ultimaCompra = datasOrdenadas[0];
            }
            
            // Formatar a data da √∫ltima compra
            let ultimaCompraFormatada = 'N/A';
            if (ultimaCompra) {
                try {
                    const dt = new Date(ultimaCompra);
                    ultimaCompraFormatada = dt.toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch {
                    ultimaCompraFormatada = 'N/A';
                }
            }
            
            let html = `
                <div style="color: var(--text); margin-bottom: 20px;">
                    <h3 style="color: var(--accent);">Cliente: ${hashCliente}</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${totalCompras}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Total de Compras</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">R$ ${valorTotal.toFixed(2)}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Valor Total</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">R$ ${ticketMedio.toFixed(2)}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Ticket M√©dio</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; font-weight: bold; color: #f59e0b;">${ultimaCompraFormatada}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">√öltima Compra</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: var(--accent); margin-bottom: 15px;">üì¶ Hist√≥rico de Pedidos (${totalCompras})</h4>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.05); border-bottom: 2px solid var(--border);">
                                <th style="padding: 10px; text-align: left;">ID Pedido</th>
                                <th style="padding: 10px; text-align: left;">Data</th>
                                <th style="padding: 10px; text-align: right;">Valor</th>
                                <th style="padding: 10px; text-align: center;">Status</th>
                                <th style="padding: 10px; text-align: center;">Nota</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            vendasCliente.forEach(v => {
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px;">${v.id_pedido}</td>
                        <td style="padding: 10px;">${v.data_compra ? new Date(v.data_compra).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td style="padding: 10px; text-align: right; color: #10b981; font-weight: bold;">R$ ${parseFloat(v.valor_total_pagamento || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: center;">${v.status_pedido || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center;">${v.nota_avaliacao ? '‚≠ê'.repeat(v.nota_avaliacao) : '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="fecharModal('historicoClienteModal')">Fechar</button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'flex';
            
        } catch(err) {
            console.error(err);
            alert('‚ùå Erro ao carregar hist√≥rico do cliente');
        }
    };
    
    // Fun√ß√£o: Excluir Venda
    window.excluirVenda = async function(id, idPedido) {
        if(!confirm(`Deseja realmente excluir o pedido ${idPedido}?`)) return;
        
        try{
            const resp = await fetch(`{{ url_for('main.historicovendas') }}?action=delete`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, user_id: userId})
            });
            const result = await resp.json();
            if(result.success){
                await loadData();
                alert('‚úÖ Venda exclu√≠da com sucesso!');
            } else {
                alert('‚ùå Erro ao excluir: ' + (result.error || 'desconhecido'));
            }
        }catch(err){
            console.error(err);
            alert('‚ùå Erro ao excluir venda');
        }
    };
    
})();
</script>
{% endblock %}
