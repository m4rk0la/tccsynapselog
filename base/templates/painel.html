{% extends "layout_base.html" %}

{% block title %}Dashboard - SynapseLog{% endblock %}

{% block extra_css %}
<style>

        /* Dashboard Header */
        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.success { background: rgba(72, 187, 120, 0.15); }
        .stat-icon.warning { background: rgba(237, 137, 54, 0.15); }
        .stat-icon.danger { background: rgba(245, 101, 101, 0.15); }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(72, 187, 120, 0.15);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(245, 101, 101, 0.15);
            color: var(--danger);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .chart-filter {
            background: var(--darker-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Secondary Charts */
        .secondary-charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Table */
        .table-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            background: var(--darker-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.completed {
            background: rgba(72, 187, 120, 0.15);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(237, 137, 54, 0.15);
            color: var(--warning);
        }

        /* Floating Chat Button */
        /* Honeycomb Loading Animation */
        @-webkit-keyframes honeycomb {
            0%, 20%, 80%, 100% {
                opacity: 0;
                -webkit-transform: scale(0);
                transform: scale(0);
            }
            30%, 70% {
                opacity: 1;
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @keyframes honeycomb {
            0%, 20%, 80%, 100% {
                opacity: 0;
                -webkit-transform: scale(0);
                transform: scale(0);
            }
            30%, 70% {
                opacity: 1;
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        .honeycomb {
            height: 24px;
            position: relative;
            width: 24px;
        }

        .honeycomb div {
            -webkit-animation: honeycomb 2.1s infinite backwards;
            animation: honeycomb 2.1s infinite backwards;
            background: #667eea;
            height: 12px;
            margin-top: 6px;
            position: absolute;
            width: 24px;
        }

        .honeycomb div:after, .honeycomb div:before {
            content: '';
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            position: absolute;
            left: 0;
            right: 0;
        }

        .honeycomb div:after {
            top: -6px;
            border-bottom: 6px solid #667eea;
        }

        .honeycomb div:before {
            bottom: -6px;
            border-top: 6px solid #667eea;
        }

        .honeycomb div:nth-child(1) {
            -webkit-animation-delay: 0s;
            animation-delay: 0s;
            left: -28px;
            top: 0;
        }

        .honeycomb div:nth-child(2) {
            -webkit-animation-delay: 0.1s;
            animation-delay: 0.1s;
            left: -14px;
            top: 22px;
        }

        .honeycomb div:nth-child(3) {
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s;
            left: 14px;
            top: 22px;
        }

        .honeycomb div:nth-child(4) {
            -webkit-animation-delay: 0.3s;
            animation-delay: 0.3s;
            left: 28px;
            top: 0;
        }

        .honeycomb div:nth-child(5) {
            -webkit-animation-delay: 0.4s;
            animation-delay: 0.4s;
            left: 14px;
            top: -22px;
        }

        .honeycomb div:nth-child(6) {
            -webkit-animation-delay: 0.5s;
            animation-delay: 0.5s;
            left: -14px;
            top: -22px;
        }

        .honeycomb div:nth-child(7) {
            -webkit-animation-delay: 0.6s;
            animation-delay: 0.6s;
            left: 0;
            top: 0;
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 32, 44, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
            border-radius: 12px;
        }

        .map-loading-overlay p {
            color: var(--text-muted);
            font-size: 14px;
            margin: 0;
        }
    </style>
{% endblock %}

{% block content %}
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>Dashboard</h1>
            <p>Acompanhe em tempo real o andamento da sua opera√ß√£o.</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon success">‚úì</div>
                <div class="stat-info">
                    <div class="stat-label">Clientes com √Årea Definida</div>
                    <div class="stat-value" id="clients-with-area">
                        {% if stats %}
                            {{ stats.total_clients - stats.clients_without_area }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">‚ö†</div>
                <div class="stat-info">
                    <div class="stat-label">Clientes Sem √Årea</div>
                    <div class="stat-value" id="clients-without-area">
                        {{ stats.clients_without_area if stats else 0 }}
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon danger">Œ£</div>
                <div class="stat-info">
                    <div class="stat-label">Total de Clientes</div>
                    <div class="stat-value" id="total-clients">
                        {{ stats.total_clients if stats else 0 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div style="flex: 1;">
                        <div class="chart-title">Rotas Planejadas</div>
                        <div class="chart-subtitle">Visualiza√ß√£o de rotas otimizadas e navega√ß√£o</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select class="chart-filter" id="select-rota" onchange="carregarClustersRota()" style="min-width: 200px;">
                            <option value="">1. Selecione a rota...</option>
                        </select>
                        <select class="chart-filter" id="select-ponto-saida" onchange="habilitarSelectDia()" style="min-width: 200px;" disabled>
                            <option value="">2. Selecione o ponto de sa√≠da...</option>
                        </select>
                        <select class="chart-filter" id="select-cluster" onchange="renderizarRotaNoMapa()" style="min-width: 180px;" disabled>
                            <option value="">3. Selecione o dia...</option>
                        </select>
                    </div>
                </div>
                <div id="map-rotas" style="height: 500px; border-radius: 8px; overflow: hidden; position: relative;">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); background: var(--darker-bg);">
                        <div style="text-align: center; padding: 40px;">
                            <p style="font-size: 64px; margin-bottom: 16px;">üó∫Ô∏è</p>
                            <p style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Visualize a rota</p>
                            <p style="font-size: 14px; color: var(--text-muted);">
                                1. Selecione uma rota<br>
                                2. Escolha o ponto de sa√≠da<br>
                                3. Selecione o dia/cluster<br>
                                4. Visualize a rota otimizada
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Painel de Informa√ß√µes da Rota -->
                <div id="info-rota" style="margin-top: 16px; padding: 16px; background: var(--darker-bg); border-radius: 8px; display: none;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">üìç Clientes</div>
                            <div style="font-size: 20px; font-weight: 700;" id="info-num-clientes">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">üìè Dist√¢ncia Total</div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;" id="info-distancia">-- km</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">‚è±Ô∏è Tempo Estimado</div>
                            <div style="font-size: 20px; font-weight: 700; color: #48bb78;" id="info-tempo">-- min</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">üìÖ Dia</div>
                            <div style="font-size: 20px; font-weight: 700; color: #ed8936;" id="info-dia">--</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button onclick="exportarRotaDia()" style="flex: 1; padding: 8px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üì• Exportar Rota do Dia
                        </button>
                        <button onclick="abrirGoogleMapsNavegacao()" style="flex: 1; padding: 8px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üß≠ Abrir Navega√ß√£o
                        </button>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Total de Clientes por √Årea</div>
                        <div class="chart-subtitle">Distribui√ß√£o de clientes nas √°reas cadastradas</div>
                    </div>
                </div>
                <div class="chart-container" style=" max-height: 300px;">
                    <div id="clients-by-area-list">
                        {% if stats and stats.clients_by_area %}
                            {% for area_name, count in stats.clients_by_area.items() %}
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text);">{{ area_name }}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">√Årea de Vendas</div>
                                    </div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--accent);">{{ count }}</div>
                                </div>
                            {% endfor %}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(237, 137, 54, 0.1); border-radius: 8px; margin-top: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--warning);">‚ö† Sem √Årea Definida</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Clientes n√£o atribu√≠dos</div>
                                </div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--warning);">{{ stats.clients_without_area }}</div>
                            </div>
                        {% else %}
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <p>üìç Nenhuma √°rea cadastrada</p>
                                <p style="font-size: 12px;">Crie √°reas em "Grupos" para visualizar a distribui√ß√£o</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts -->
        <div class="secondary-charts">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Top 10 Produtos Mais Vendidos</div>
                        <div class="stat-label">Baseado no hist√≥rico de vendas</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="customersChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Formas de Pagamento</div>
                        <div class="stat-label">Hist√≥rico de vendas</div>
                    </div>
                </div>
                <div style="margin-top: 20px; height: 200px; position: relative;">
                    <canvas id="pagamentosChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Calend√°rios de Rotas Salvos -->
        <div class="table-card">
            <div class="table-header">
                <div>
                    <div class="chart-title">Calend√°rios de Rotas Salvos</div>
                    <div class="chart-subtitle">Gerenciar rotas planejadas e calend√°rios</div>
                </div>
                <div class="table-actions">
                    <button class="btn-secondary" onclick="window.location.href='/autenticado/roteirizacao'">
                        ‚ûï Nova Roteiriza√ß√£o
                    </button>
                </div>
            </div>
            <div id="calendarios-container" style="padding: 20px;">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <p>‚è≥ Carregando calend√°rios...</p>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Google Maps API com loading otimizado -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqGUhDl7xvwsNzilgPWO3kBKn-1-sQ1OY&loading=async&callback=initGoogleMaps"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Fun√ß√£o para mostrar toast
        function mostrarToast(mensagem) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                font-size: 15px;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = mensagem;
            
            // Adiciona anima√ß√£o
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            // Remove ap√≥s 4 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // ==================== INICIALIZA√á√ÉO √öNICA ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica toast de calend√°rio salvo
            const calendarioSalvo = sessionStorage.getItem('calendario_salvo');
            const calendarioId = sessionStorage.getItem('calendario_id');
            
            if (calendarioSalvo === 'true' && calendarioId) {
                sessionStorage.removeItem('calendario_salvo');
                sessionStorage.removeItem('calendario_id');
                mostrarToast(`‚úÖ Rota salva com sucesso! ID: ${calendarioId}`);
            }
            
            // Carrega dados din√¢micos
            updateClientStats();
            carregarNovosClientesChart();
            carregarTopClientes();
            carregarFormasPagamento();
            carregarCalendarios();
            carregarCalendariosNoMapa();
        });
        
        // ==================== TOP CLIENTES MAIS VISITADOS ====================
        async function carregarTopClientes() {
            const container = document.getElementById('top-clientes-container');
            
            try {
                const response = await fetch('/autenticado/painel/top-clientes');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar top clientes');
                }
                
                const clientes = data.clientes || [];
                
                if (clientes.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <p style="font-size: 36px; margin-bottom: 8px;">üí∞</p>
                            <p style="font-size: 14px;">Nenhum hist√≥rico de vendas</p>
                            <p style="font-size: 12px; margin-top: 4px;">Importe vendas para ver os top clientes</p>
                        </div>
                    `;
                    return;
                }
                
                // Renderiza lista de top clientes com barras horizontais
                let html = '<div style="display: flex; flex-direction: column; gap: 14px;">';
                
                // Encontra o maior valor para normalizar as barras
                const maxValor = Math.max(...clientes.map(c => c.valor_total));
                
                clientes.forEach((cliente, index) => {
                    const porcentagem = (cliente.valor_total / maxValor) * 100;
                    const cores = ['#667eea', '#48bb78', '#ed8936', '#4299e1', '#9f7aea'];
                    const cor = cores[index % cores.length];
                    
                    html += `
                        <div style="position: relative; padding-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; position: relative; z-index: 1;">
                                <div style="display: flex; align-items: flex-start; gap: 10px; flex: 1;">
                                    <div style="min-width: 32px; height: 32px; border-radius: 8px; background: ${cor}; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 14px; box-shadow: 0 2px 8px ${cor}40;">
                                        ${index + 1}
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; color: var(--text); font-size: 14px; line-height: 1.3; margin-bottom: 2px;">
                                            ${cliente.nome}
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span>üì¶ ${cliente.total_pedidos} pedido${cliente.total_pedidos > 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right; margin-left: 12px;">
                                    <div style="font-size: 16px; font-weight: 700; color: ${cor}; white-space: nowrap;">
                                        R$ ${cliente.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </div>
                                    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">
                                        total gasto
                                    </div>
                                </div>
                            </div>
                            <div style="height: 5px; width: 100%; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                                <div class="barra-progresso" style="height: 100%; width: 0%; background: linear-gradient(90deg, ${cor}, ${cor}80); border-radius: 3px; box-shadow: 0 0 10px ${cor}40; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);" data-width="${porcentagem}"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Anima as barras ap√≥s renderiza√ß√£o
                setTimeout(() => {
                    const barras = container.querySelectorAll('.barra-progresso');
                    barras.forEach(barra => {
                        const width = barra.getAttribute('data-width');
                        barra.style.width = width + '%';
                    });
                }, 100);
                
            } catch (error) {
                console.error('Erro ao carregar top clientes:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <p>‚ùå Erro ao carregar dados</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ==================== FORMAS DE PAGAMENTO ====================
        let pagamentosChartInstance = null;
        
        async function carregarFormasPagamento() {
            try {
                const response = await fetch('/autenticado/painel/formas-pagamento');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar formas de pagamento');
                }
                
                const canvas = document.getElementById('pagamentosChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Se n√£o houver dados, mostra mensagem
                if (!data.labels || data.labels.length === 0) {
                    canvas.parentElement.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 200px; text-align: center; color: var(--text-muted);">
                            <div>
                                <p style="font-size: 36px; margin-bottom: 8px;">üí≥</p>
                                <p style="font-size: 14px;">Nenhum hist√≥rico de vendas</p>
                                <p style="font-size: 12px; margin-top: 4px;">Importe vendas para ver as formas de pagamento</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Destroi inst√¢ncia anterior se existir
                if (pagamentosChartInstance) {
                    pagamentosChartInstance.destroy();
                }
                
                // Cores vibrantes para cada forma de pagamento
                const coresPagamento = [
                    '#667eea',  // Roxo
                    '#48bb78',  // Verde
                    '#ed8936',  // Laranja
                    '#283beb',  // Azul
                    '#9f7aea',  // Lil√°s
                ];
                
                pagamentosChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: coresPagamento.slice(0, data.labels.length),
                            borderWidth: 3,
                            borderColor: '#1a202c',
                            hoverBorderColor: '#fff',
                            hoverBorderWidth: 3,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: { 
                            legend: { 
                                position: 'right',
                                labels: { 
                                    color: '#e2e8f0', 
                                    font: { size: 14},
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        const labels = chart.data.labels;
                                        const percentuais = data.percentuais;
                                        
                                        return labels.map((label, i) => ({
                                            text: `${label} (${percentuais[i]}%)`,
                                            fillStyle: datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i,
                                            fontColor: '#e2e8f0'
                                        }));
                                    }
                                },
                                onHover: (e) => { e.native.target.style.cursor = 'pointer'; },
                                onLeave: (e) => { e.native.target.style.cursor = 'default'; }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 30, 30, 0.95)',
                                titleColor: '#e2e8f0',
                                bodyColor: '#a0aec0',
                                borderColor: '#667eea',
                                borderWidth: 1,
                                padding: 12,
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const percentual = data.percentuais[context.dataIndex];
                                        return `${label}: ${value} pedidos (${percentual}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar formas de pagamento:', error);
                const canvas = document.getElementById('pagamentosChart');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 200px; text-align: center; color: var(--danger);">
                            <div>
                                <p>‚ùå Erro ao carregar dados</p>
                                <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // ==================== CHARTS ====================
        let customersChartInstance = null; // Armazena inst√¢ncia do gr√°fico
        
        async function carregarNovosClientesChart() {
            try {
                const response = await fetch('/autenticado/painel/novos-clientes');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar dados');
                }
                
                const labels = data.labels || [];
                const valores = data.valores || [];
                
                // Renderiza o gr√°fico
                const ctx = document.getElementById('customersChart');
                if (ctx) {
                    // Destroi inst√¢ncia anterior se existir
                    if (customersChartInstance) {
                        customersChartInstance.destroy();
                    }
                    
                    if (labels.length === 0) {
                        // Mostra mensagem quando n√£o h√° dados
                        const container = ctx.parentElement;
                        container.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 280px; flex-direction: column; color: var(--text-muted);">
                                <p style="font-size: 36px; margin-bottom: 8px;">üì¶</p>
                                <p style="font-size: 14px;">Nenhum produto vendido ainda</p>
                                <p style="font-size: 12px; margin-top: 4px;">Importe o hist√≥rico de vendas</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Cor √∫nica do sistema SynapseLog
                    const corSynapse = '#667eea';
                    const backgroundColors = valores.map(() => corSynapse);
                    
                    customersChartInstance = new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade Vendida',
                                data: valores,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors,
                                borderWidth: 2,
                                borderRadius: 6,
                                barThickness: 28
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const produto = context.label;
                                            const quantidade = context.parsed.y;
                                            return `${produto}: ${quantidade} unidade${quantidade !== 1 ? 's' : ''}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.6)',
                                        font: {
                                            size: 10
                                        },
                                        maxRotation: 45,
                                        minRotation: 45,
                                        autoSkip: false
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.6)',
                                        font: {
                                            size: 11
                                        },
                                        precision: 0
                                    }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Erro ao carregar gr√°fico de produtos:', error);
                const ctx = document.getElementById('customersChart');
                if (ctx) {
                    const container = ctx.parentElement;
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 280px; flex-direction: column; color: var(--danger);">
                            <p>‚ùå Erro ao carregar dados</p>
                            <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        function initializeCharts() {
            // Orders Chart (Bar) - N√£o usado no momento
            if (document.getElementById('ordersChart')) {
                const ordersCtx = document.getElementById('ordersChart').getContext('2d');
                
                // Gradiente vertical para as barras
                const barGradient = ordersCtx.createLinearGradient(0, 0, 0, 150);
                barGradient.addColorStop(0, '#667eea');
                barGradient.addColorStop(1, '#764ba2');
                
                new Chart(ordersCtx, {
                    type: 'bar',
                    data: {
                        labels: ['', '', '', '', '', '', ''],
                        datasets: [{
                            data: [30, 45, 40, 55, 50, 45, 60],
                            backgroundColor: barGradient,
                            borderRadius: 6,
                            borderSkipped: false,
                            barThickness: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(30, 30, 30, 0.95)',
                                padding: 10,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: { 
                                display: false,
                                beginAtZero: true
                            },
                            x: { 
                                display: false
                            }
                        },
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // Paying Chart (Doughnut)
            if (document.getElementById('payingChart')) {
                const payingCtx = document.getElementById('payingChart').getContext('2d');
                new Chart(payingCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Paying customer', 'Non-paying customer'],
                        datasets: [{
                            data: [30, 70],
                            backgroundColor: [
                                '#667eea',
                                'rgba(255, 255, 255, 0.1)'
                            ],
                            borderWidth: 3,
                            borderColor: '#1a202c',
                            hoverBorderColor: '#fff',
                            hoverBorderWidth: 3,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { 
                            legend: { 
                                position: 'right',
                                labels: { 
                                    color: '#ffffff', 
                                    font: { size: 11 },
                                    padding: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 30, 30, 0.95)',
                                padding: 12,
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed}%`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
            }
        }

        // Fun√ß√£o para atualizar estat√≠sticas de clientes por √°rea
        async function updateClientStats() {
            try {
                const response = await fetch('/autenticado/painel/stats');
                const data = await response.json();
                
                if (data.success) {
                    // Atualiza cards de estat√≠sticas
                    const clientsWithArea = data.total_clients - data.clients_without_area;
                    document.getElementById('clients-with-area').textContent = clientsWithArea;
                    document.getElementById('clients-without-area').textContent = data.clients_without_area;
                    document.getElementById('total-clients').textContent = data.total_clients;
                    
                    // Atualiza lista de clientes por √°rea
                    const listContainer = document.getElementById('clients-by-area-list');
                    
                    if (data.clients_by_area && data.clients_by_area.length > 0) {
                        let html = '';
                        
                        // Adiciona cada √°rea
                        data.clients_by_area.forEach(area => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text);">${area.area_name}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">√Årea de Vendas</div>
                                    </div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--accent);">${area.count}</div>
                                </div>
                            `;
                        });
                        
                        // Adiciona clientes sem √°rea
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(237, 137, 54, 0.1); border-radius: 8px; margin-top: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--warning);">‚ö† Sem √Årea Definida</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Clientes n√£o atribu√≠dos</div>
                                </div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--warning);">${data.clients_without_area}</div>
                            </div>
                        `;
                        
                        listContainer.innerHTML = html;
                    } else {
                        listContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <p>üìç Nenhuma √°rea cadastrada</p>
                                <p style="font-size: 12px;">Crie √°reas em "Grupos" para visualizar a distribui√ß√£o</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }
        
        // Atualiza estat√≠sticas ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            updateClientStats();
            carregarCalendarios();
            carregarCalendariosNoMapa();
        });
        
        // Opcional: Atualiza a cada 30 segundos
        setInterval(updateClientStats, 30000);
        
        // ==================== CALEND√ÅRIOS SALVOS ====================
        
        async function carregarCalendarios() {
            const container = document.getElementById('calendarios-container');
            
            try {
                const response = await fetch('/autenticado/roteirizacao/calendarios');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar calend√°rios');
                }
                
                const calendarios = data.calendarios || [];
                
                if (calendarios.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <p style="font-size: 48px; margin-bottom: 16px;">üìÖ</p>
                            <p style="font-size: 16px; font-weight: 600; color: var(--text);">Nenhum calend√°rio salvo ainda</p>
                            <p style="font-size: 14px; margin-top: 8px;">Crie sua primeira roteiriza√ß√£o e salve o calend√°rio!</p>
                            <button onclick="window.location.href='/autenticado/roteirizacao'" 
                                    style="margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                           color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ‚ûï Nova Roteiriza√ß√£o
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Renderiza cards dos calend√°rios
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${calendarios.map(cal => renderizarCardCalendario(cal)).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar calend√°rios:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <p>‚ùå Erro ao carregar calend√°rios</p>
                        <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderizarCardCalendario(calendario) {
            const dataCriacao = new Date(calendario.created_at).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            return `
                <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; 
                            padding: 20px; transition: all 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px;">
                                ${calendario.nome}
                            </h3>
                            <div style="font-size: 13px; color: var(--text-muted);">
                                üìÖ ${dataCriacao}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                    width: 48px; height: 48px; border-radius: 12px; display: flex; 
                                    align-items: center; justify-content: center; font-size: 24px;">
                            üóìÔ∏è
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #667eea;">
                                ${calendario.total_clusters || 0}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                Clusters
                            </div>
                        </div>
                        <div style="background: rgba(72, 187, 120, 0.1); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #48bb78;">
                                ${calendario.total_clientes || 0}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                Clientes
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button onclick="visualizarCalendario(${calendario.id})" 
                                style="flex: 1; padding: 10px; background: var(--accent); color: white; 
                                       border: none; border-radius: 8px; cursor: pointer; font-weight: 600; 
                                       font-size: 14px; transition: all 0.2s;">
                            üëÅÔ∏è Visualizar
                        </button>
                        <button onclick="exportarCalendario(${calendario.id})" 
                                style="flex: 1; padding: 10px; background: var(--border); color: var(--text); 
                                       border: none; border-radius: 8px; cursor: pointer; font-weight: 600; 
                                       font-size: 14px; transition: all 0.2s;">
                            üì• Exportar
                        </button>
                        <button onclick="deletarCalendario(${calendario.id})" 
                                style="padding: 10px 16px; background: rgba(245, 101, 101, 0.1); color: var(--danger); 
                                       border: none; border-radius: 8px; cursor: pointer; font-weight: 600; 
                                       font-size: 14px; transition: all 0.2s;">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function visualizarCalendario(id) {
            // TODO: Implementar modal/p√°gina de visualiza√ß√£o detalhada
            alert(`Visualiza√ß√£o do calend√°rio ${id} - Em desenvolvimento`);
        }
        
        async function exportarCalendario(id) {
            try {
                const response = await fetch(`/autenticado/roteirizacao/calendario/${id}/exportar-clientes`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao exportar');
                }
                
                // Download do JSON
                const dataStr = JSON.stringify(data.resultado, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `calendario_${id}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarToast('‚úÖ Calend√°rio exportado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert(`‚ùå Erro ao exportar: ${error.message}`);
            }
        }
        
        async function deletarCalendario(id) {
            if (!confirm('Tem certeza que deseja deletar este calend√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const response = await fetch(`/autenticado/roteirizacao/calendario/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao deletar');
                }
                
                mostrarToast('‚úÖ Calend√°rio deletado com sucesso!');
                carregarCalendarios(); // Recarrega lista
                
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert(`‚ùå Erro ao deletar: ${error.message}`);
            }
        }

        // =============================================
        // üó∫Ô∏è MAPA DE ROTAS COM GOOGLE MAPS
        // =============================================
        
        let mapaGoogle = null;
        let googleMapsLoaded = false;
        let directionsService = null;
        let directionsRenderer = null;
        let calendariosSalvos = [];
        let rotaSelecionada = null;
        let clusterSelecionado = null;
        let markersArray = [];
        const cores = ['#667eea', '#f56565', '#48bb78', '#ed8936', '#38b2ac', '#9f7aea', '#ed64a6', '#ecc94b'];
        const mapStyles = [
            { featureType: 'poi', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.medical', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.place_of_worship', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.attraction', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.government', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.park', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.sports_complex', stylers: [{ visibility: 'off' }] },
            { featureType: 'transit.station', stylers: [{ visibility: 'off' }] }
        ];
        
        // Callback quando Google Maps carrega
        window.initGoogleMaps = function() {
            console.log('‚úÖ Google Maps API carregada');
            googleMapsLoaded = true;
        };
        
        // Carrega calend√°rios no primeiro select
        async function carregarCalendariosNoMapa() {
            try {
                const response = await fetch('/autenticado/roteirizacao/calendarios');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar calend√°rios');
                }
                
                calendariosSalvos = data.calendarios || [];
                
                const select = document.getElementById('select-rota');
                select.innerHTML = '<option value="">1. Selecione a rota...</option>';
                
                calendariosSalvos.forEach(cal => {
                    const option = document.createElement('option');
                    option.value = cal.id;
                    option.textContent = `${cal.nome} (${cal.total_clusters} dias, ${cal.total_clientes} clientes)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Erro ao carregar calend√°rios:', error);
            }
        }
        
        // Carrega clusters/dias da rota selecionada no segundo select
        async function carregarClustersRota() {
            const selectRota = document.getElementById('select-rota');
            const selectPontoSaida = document.getElementById('select-ponto-saida');
            const selectCluster = document.getElementById('select-cluster');
            const calendarioId = selectRota.value;
            
            // Reset
            selectPontoSaida.innerHTML = '<option value="">2. Selecione o ponto de sa√≠da...</option>';
            selectPontoSaida.disabled = true;
            selectCluster.innerHTML = '<option value="">3. Selecione o dia...</option>';
            selectCluster.disabled = true;
            rotaSelecionada = null;
            clusterSelecionado = null;
            document.getElementById('info-rota').style.display = 'none';
            
            if (!calendarioId) {
                limparMapa();
                return;
            }
            
            try {
                // Busca dados do calend√°rio e pontos de sa√≠da em paralelo
                const [calResponse, pontosResponse] = await Promise.all([
                    fetch(`/autenticado/roteirizacao/calendario/${calendarioId}/exportar-clientes`),
                    fetch('/autenticado/painel/pontos-saida')
                ]);
                
                if (!calResponse.ok) {
                    throw new Error(`HTTP error! status: ${calResponse.status}`);
                }
                
                const data = await calResponse.json();
                console.log('üì¶ Dados recebidos do backend:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar rota');
                }
                
                // Valida estrutura dos dados
                if (!data.dias || !Array.isArray(data.dias)) {
                    console.error('‚ùå Estrutura inv√°lida:', data);
                    throw new Error('Dados da rota em formato inv√°lido');
                }
                
                rotaSelecionada = data;
                
                // Carrega pontos de sa√≠da
                if (pontosResponse.ok) {
                    const pontosData = await pontosResponse.json();
                    if (pontosData.success && pontosData.pontos && pontosData.pontos.length > 0) {
                        pontosData.pontos.forEach((ponto, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.dataset.latitude = ponto.latitude;
                            option.dataset.longitude = ponto.longitude;
                            option.dataset.hash = ponto.hash_client;
                            option.textContent = ponto.nome || `Ponto ${index + 1}`;
                            selectPontoSaida.appendChild(option);
                        });
                        selectPontoSaida.disabled = false;
                        
                        // Armazena pontos globalmente
                        window.pontosSaida = pontosData.pontos;
                    } else {
                        console.warn('‚ö†Ô∏è Nenhum ponto de sa√≠da encontrado');
                        alert('‚ö†Ô∏è Configure ao menos um ponto de sa√≠da em "Pontos de Sa√≠da"');
                    }
                }
                
                mostrarToast(`‚úÖ Rota carregada: ${data.dias.length} dias dispon√≠veis`);
                
            } catch (error) {
                console.error('Erro ao carregar clusters:', error);
                alert(`‚ùå Erro: ${error.message}`);
            }
        }
        
        // Habilita select de dia ap√≥s escolher ponto de sa√≠da
        function habilitarSelectDia() {
            const selectPontoSaida = document.getElementById('select-ponto-saida');
            const selectCluster = document.getElementById('select-cluster');
            
            if (selectPontoSaida.value && rotaSelecionada) {
                // Popula select de clusters/dias
                selectCluster.innerHTML = '<option value="">3. Selecione o dia...</option>';
                
                rotaSelecionada.dias.forEach((dia, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${dia.dia} - Cluster ${dia.cluster_id} (${dia.clientes.length} clientes)`;
                    selectCluster.appendChild(option);
                });
                
                selectCluster.disabled = false;
            } else {
                selectCluster.disabled = true;
            }
        }
        
        // Renderiza a rota do dia/cluster selecionado no Google Maps
        async function renderizarRotaNoMapa() {
            const selectCluster = document.getElementById('select-cluster');
            const clusterIndex = selectCluster.value;
            
            if (clusterIndex === '' || !rotaSelecionada) {
                limparMapa();
                return;
            }
            
            if (!googleMapsLoaded) {
                // Mostra overlay de loading com anima√ß√£o honeycomb
                const mapContainer = document.getElementById('map-rotas');
                mapContainer.innerHTML = `
                    <div class="map-loading-overlay">
                        <div class="honeycomb">
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                        <p>Aguarde, carregando Google Maps...</p>
                    </div>
                `;
                return;
            }
            
            clusterSelecionado = rotaSelecionada.dias[clusterIndex];
            
            console.log('üìç Cluster selecionado:', clusterSelecionado);
            console.log('üë• Total de clientes:', clusterSelecionado.clientes.length);
            console.log('üìä Primeiros 3 clientes:', clusterSelecionado.clientes.slice(0, 3));
            
            // Atualiza painel de informa√ß√µes
            document.getElementById('info-rota').style.display = 'block';
            document.getElementById('info-num-clientes').textContent = clusterSelecionado.clientes.length;
            document.getElementById('info-dia').textContent = clusterSelecionado.dia;
            
            try {
                // Busca ponto de sa√≠da selecionado
                const selectPontoSaida = document.getElementById('select-ponto-saida');
                const pontoIndex = selectPontoSaida.value;
                let pontoSaida = null;
                
                if (pontoIndex !== '' && window.pontosSaida && window.pontosSaida[pontoIndex]) {
                    pontoSaida = window.pontosSaida[pontoIndex];
                    console.log('üè¢ Ponto de sa√≠da selecionado:', pontoSaida);
                }
                
                // Limpa container e cria elemento do mapa
                const mapContainer = document.getElementById('map-rotas');
                mapContainer.innerHTML = '';

                // Reinicia servi√ßos de dire√ß√µes para evitar res√≠duos de mapas anteriores
                if (directionsRenderer) {
                    directionsRenderer.setMap(null);
                    directionsRenderer = null;
                }
                directionsService = null;
                
                // Calcula centro do mapa (primeira coordenada v√°lida)
                const primeiroCliente = clusterSelecionado.clientes[0];
                const centroLat = parseFloat(pontoSaida ? pontoSaida.latitude : primeiroCliente.latitude);
                const centroLng = parseFloat(pontoSaida ? pontoSaida.longitude : primeiroCliente.longitude);
                
                // Valida coordenadas
                if (isNaN(centroLat) || isNaN(centroLng)) {
                    throw new Error('Coordenadas inv√°lidas para centralizar mapa');
                }
                
                // Inicializa mapa Google
                mapaGoogle = new google.maps.Map(mapContainer, {
                    center: { lat: centroLat, lng: centroLng },
                    zoom: 12,
                    mapTypeId: 'roadmap',
                    mapTypeControl: false,
                    streetViewControl: true,
                    fullscreenControl: true,
                    styles: mapStyles
                });
                
                // Limpa marcadores anteriores
                markersArray.forEach(marker => marker.setMap(null));
                markersArray = [];
                
                const bounds = new google.maps.LatLngBounds();
                
                // Adiciona marcador do ponto de sa√≠da
                if (pontoSaida) {
                    const markerBase = new google.maps.Marker({
                        position: { lat: parseFloat(pontoSaida.latitude), lng: parseFloat(pontoSaida.longitude) },
                        map: mapaGoogle,
                        title: 'Ponto de Sa√≠da',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 15,
                            fillColor: '#667eea',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 3
                        },
                        label: {
                            text: 'üè¢',
                            fontSize: '16px'
                        }
                    });
                    
                    const infoBase = new google.maps.InfoWindow({
                        content: `<div style="padding: 8px;"><b>üè¢ Ponto de Sa√≠da</b><br>${pontoSaida.nome}</div>`
                    });
                    
                    markerBase.addListener('click', () => {
                        infoBase.open(mapaGoogle, markerBase);
                    });
                    
                    markersArray.push(markerBase);
                    bounds.extend(markerBase.position);
                }
                
                // Adiciona marcadores dos clientes
                const waypoints = [];
                clusterSelecionado.clientes.forEach((cliente, idx) => {
                    const lat = parseFloat(cliente.latitude);
                    const lng = parseFloat(cliente.longitude);
                    
                    console.log(`Cliente ${idx + 1} - ${cliente.nome}:`, { lat, lng, original: { latitude: cliente.latitude, longitude: cliente.longitude } });
                    
                    if (isNaN(lat) || isNaN(lng)) {
                        console.warn(`Cliente ${idx + 1} com coordenadas inv√°lidas:`, cliente);
                        return;
                    }
                    
                    const posicao = { lat: lat, lng: lng };
                    
                    const marker = new google.maps.Marker({
                        position: posicao,
                        map: mapaGoogle,
                        title: cliente.nome,
                        label: {
                            text: `${idx + 1}`,
                            color: '#ffffff',
                            fontSize: '14px',
                            fontWeight: 'bold'
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: cores[idx % cores.length],
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 8px; max-width: 250px;">
                                <b>Cliente ${idx + 1}</b><br>
                                ${cliente.nome}<br>
                                <small>üìç ${cliente.cidade}, ${cliente.estado}</small><br>
                                <small>üìä Score: ${cliente.score ? cliente.score.toFixed(1) : 'N/A'}</small><br>
                                <small>üìÖ Dia: ${clusterSelecionado.dia}</small>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(mapaGoogle, marker);
                    });
                    
                    markersArray.push(marker);
                    bounds.extend(marker.position);
                    waypoints.push(posicao);
                });
                
                // Ajusta zoom inicial com base nos marcadores
                mapaGoogle.fitBounds(bounds);

                if (waypoints.length > 0) {
                    document.getElementById('info-distancia').textContent = 'Calculando...';
                    document.getElementById('info-tempo').textContent = 'Calculando...';
                    calcularERenderizarRota(pontoSaida, waypoints, bounds);
                } else {
                    document.getElementById('info-distancia').textContent = 'N/A';
                    document.getElementById('info-tempo').textContent = 'N/A';
                }
                
                mostrarToast(`üó∫Ô∏è Mapa renderizado: ${clusterSelecionado.clientes.length} clientes`);
                
            } catch (error) {
                console.error('Erro ao renderizar mapa:', error);
                alert(`‚ùå Erro ao renderizar mapa: ${error.message}`);
            }
        }
        
        // Calcula e renderiza rota otimizada
        function calcularERenderizarRota(pontoSaida, waypoints, bounds = null) {
            if (!waypoints || waypoints.length === 0) {
                document.getElementById('info-distancia').textContent = 'N/A';
                document.getElementById('info-tempo').textContent = 'N/A';
                if (bounds && !bounds.isEmpty()) {
                    mapaGoogle.fitBounds(bounds);
                }
                return;
            }

            if (!directionsService) {
                directionsService = new google.maps.DirectionsService();
            }

            if (!directionsRenderer) {
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: mapaGoogle,
                    suppressMarkers: true, // Usa nossos marcadores customizados
                    polylineOptions: {
                        strokeColor: '#3b82f6',
                        strokeWeight: 4,
                        strokeOpacity: 0.85
                    }
                });
            } else {
                directionsRenderer.setMap(mapaGoogle);
                directionsRenderer.set('directions', null);
            }

            const possuiPontoSaida = pontoSaida &&
                !isNaN(parseFloat(pontoSaida.latitude)) &&
                !isNaN(parseFloat(pontoSaida.longitude));

            const origem = possuiPontoSaida
                ? { lat: parseFloat(pontoSaida.latitude), lng: parseFloat(pontoSaida.longitude) }
                : waypoints[0];

            const destino = possuiPontoSaida
                ? { lat: parseFloat(pontoSaida.latitude), lng: parseFloat(pontoSaida.longitude) }
                : waypoints[waypoints.length - 1];

            const waypointsIntermediarios = possuiPontoSaida
                ? waypoints.map(wp => ({ location: wp, stopover: true }))
                : waypoints.slice(1, -1).map(wp => ({ location: wp, stopover: true }));

            const request = {
                origin: origem,
                destination: destino,
                waypoints: waypointsIntermediarios,
                optimizeWaypoints: false,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK' && result.routes && result.routes.length > 0) {
                    directionsRenderer.setDirections(result);

                    const route = result.routes[0];
                    let distanciaTotal = 0;
                    let tempoTotal = 0;

                    route.legs.forEach(leg => {
                        distanciaTotal += leg.distance.value; // em metros
                        tempoTotal += leg.duration.value; // em segundos
                    });

                    document.getElementById('info-distancia').textContent = `${(distanciaTotal / 1000).toFixed(1)} km`;
                    document.getElementById('info-tempo').textContent = `${Math.round(tempoTotal / 60)} min`;

                    if (route.bounds) {
                        if (bounds) {
                            bounds.union(route.bounds);
                            mapaGoogle.fitBounds(bounds);
                        } else {
                            mapaGoogle.fitBounds(route.bounds);
                        }
                    }

                    console.log('‚úÖ Rota calculada:', {
                        distancia: `${(distanciaTotal / 1000).toFixed(1)} km`,
                        tempo: `${Math.round(tempoTotal / 60)} min`
                    });
                } else {
                    console.error('Erro ao calcular rota:', status, result);
                    document.getElementById('info-distancia').textContent = 'N/A';
                    document.getElementById('info-tempo').textContent = 'N/A';
                    if (bounds && !bounds.isEmpty()) {
                        mapaGoogle.fitBounds(bounds);
                    }
                    alert('‚ö†Ô∏è N√£o foi poss√≠vel desenhar a rota. Verifique se a Google Maps Directions API est√° habilitada.');
                }
            });
        }
        
        // Limpa o mapa
        function limparMapa() {
            const mapContainer = document.getElementById('map-rotas');
            mapContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); background: var(--darker-bg);">
                    <div style="text-align: center; padding: 40px;">
                        <p style="font-size: 64px; margin-bottom: 16px;">üó∫Ô∏è</p>
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Pronto para Google Maps</p>
                        <p style="font-size: 14px; color: var(--text-muted);">
                            1. Selecione uma rota<br>
                            2. Escolha um dia/cluster<br>
                            3. Visualize a rota otimizada
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('info-rota').style.display = 'none';
        }
        
        // Exporta dados da rota do dia selecionado
        function exportarRotaDia() {
            if (!clusterSelecionado) {
                alert('‚ö†Ô∏è Selecione um dia primeiro');
                return;
            }
            
            const dataExport = {
                calendario_id: rotaSelecionada.calendario_id,
                dia: clusterSelecionado.dia,
                cluster_id: clusterSelecionado.cluster_id,
                num_clientes: clusterSelecionado.clientes.length,
                clientes: clusterSelecionado.clientes.map((c, idx) => ({
                    ordem: idx + 1,
                    nome: c.nome,
                    cidade: c.cidade || 'N/A',
                    estado: c.estado || 'N/A',
                    latitude: c.latitude,
                    longitude: c.longitude,
                    score: c.score
                }))
            };
            
            const dataStr = JSON.stringify(dataExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rota_${clusterSelecionado.dia.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarToast('‚úÖ Rota do dia exportada!');
        }
        
        // Abre Google Maps com navega√ß√£o sequencial
        function abrirGoogleMapsNavegacao() {
            if (!clusterSelecionado) {
                alert('‚ö†Ô∏è Selecione um dia primeiro');
                return;
            }
            
            // Constr√≥i URL do Google Maps com waypoints
            const origem = clusterSelecionado.clientes[0];
            const destino = clusterSelecionado.clientes[clusterSelecionado.clientes.length - 1];
            const waypoints = clusterSelecionado.clientes.slice(1, -1)
                .map(c => `${c.latitude},${c.longitude}`)
                .join('|');
            
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origem.latitude},${origem.longitude}&destination=${destino.latitude},${destino.longitude}&waypoints=${waypoints}&travelmode=driving`;
            
            window.open(url, '_blank');
            mostrarToast('üß≠ Abrindo navega√ß√£o no Google Maps...');
        }
        
        // Inicializa ao carregar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            carregarCalendariosNoMapa();
        });
    </script>
{% endblock %}